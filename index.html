<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Timbro QR v2</title>
  <style>
    body{
      font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
      max-width:520px;margin:0 auto;padding:18px;
    }
    h1{font-size:22px;margin:0 0 8px;}
    .box{background:#f6f6f6;border-radius:14px;padding:14px;margin:10px 0;}
    label{font-size:14px; display:block; margin-bottom:6px;}

    input,button{
      width:100%;
      padding:12px;
      font-size:16px;
      border-radius:10px;
      border:1px solid #ddd;
      box-sizing:border-box;
      height:46px;
    }
    button{
      border:none;margin-top:8px;cursor:pointer;font-weight:700;color:white;
    }
    .row{display:flex;gap:10px;}
    .row button{flex:1;}

    .btn-in{ background:#1f9d55; }
    .btn-out{ background:#d64545; }
    .btn-in:disabled, .btn-out:disabled, .btn-auto:disabled {
      opacity:0.6; cursor:not-allowed;
    }

    .small{font-size:12px;opacity:.7}
    .ok{color:green;font-weight:800}
    .err{color:#b00020;font-weight:800}
    .warn{color:#c27b00;font-weight:800}

    .pin-wrap{ position:relative; }
    .pin-wrap input{ padding-right:48px; }
    .eye-btn{
      position:absolute; right:8px; top:50%; transform:translateY(-50%);
      width:32px;height:32px; background:transparent; border:none; margin:0; padding:0;
      display:flex;align-items:center;justify-content:center; cursor:pointer; color:#555; border-radius:6px;
    }
    .eye-btn:active{ background:rgba(0,0,0,0.06); }
    .eye-btn svg{ width:22px;height:22px; fill:currentColor; }

    /* ✅ piccolo “loader” testuale */
    .loading-dots::after{
      content:"";
      display:inline-block;
      width:1em;
      animation:dots 1.2s infinite steps(3,end);
    }
    @keyframes dots{
      0%{content:"";}
      33%{content:".";}
      66%{content:"..";}
      100%{content:"...";}
    }

    /* ✅ fallback locationId stile “tecnico”, solo se serve */
    .tech{
      font-size:11px; opacity:.55; margin-top:2px;
    }
  </style>
</head>
<body>
  <h1>Timbratura</h1>

  <!-- ✅ UI sede umana -->
  <div class="small" id="sede"></div>
  <div class="small" id="indirizzo" style="margin-top:3px;"></div>
  <div class="tech" id="locTech" style="display:none;"></div>

  <div class="small" id="modeHint" style="margin-top:4px; display:none;"></div>

  <div class="box">
    <label for="employeeId">Matricola</label>
    <input id="employeeId" inputmode="numeric" placeholder="es. 1042"/>

    <label for="pin" style="margin-top:10px;">PIN</label>
    <div class="pin-wrap">
      <input id="pin" inputmode="numeric" type="password" placeholder="4 cifre"/>
      <button type="button" id="eyeBtn" class="eye-btn" aria-label="Mostra/Nascondi PIN"></button>
    </div>
  </div>

  <div class="box row" id="buttons">
    <button id="btnIn" class="btn-in">ENTRATA</button>
    <button id="btnOut" class="btn-out">USCITA</button>
  </div>

  <div class="box small" id="status">Pronto.</div>

<script>
const WEBHOOK_URL = "https://script.google.com/macros/s/AKfycbw3UYl68d61ym-mPVrgh1QyphQaaWotOSgrczzNGRS3KD9euIpDg-nv60Ns06vRCfLx/exec";

const statusEl = document.getElementById("status");
const sedeEl = document.getElementById("sede");
const indirizzoEl = document.getElementById("indirizzo");
const locTechEl = document.getElementById("locTech");
const buttonsEl = document.getElementById("buttons");
const modeHintEl = document.getElementById("modeHint");
const pinInput = document.getElementById("pin");
const eyeBtn = document.getElementById("eyeBtn");

function getParam(name){
  const u = new URL(location.href);
  return u.searchParams.get(name);
}

const locationId = getParam("loc") || "UNKNOWN_SEDE";
const presetMode = getParam("mode"); // IN/OUT preimpostato

function deviceId(){
  return btoa(navigator.userAgent).slice(0,32);
}

function setStatus(msg, cls=""){
  statusEl.className = "box small " + cls;
  statusEl.textContent = msg;
}

function disableButtonsSafe(){
  const bIn = document.getElementById("btnIn");
  const bOut = document.getElementById("btnOut");
  const bAuto = document.getElementById("autoBtn");
  if (bIn) bIn.disabled = true;
  if (bOut) bOut.disabled = true;
  if (bAuto) bAuto.disabled = true;
}

/* ✅ Material eye icons */
const ICON_VISIBILITY = `
<svg viewBox="0 0 24 24"><path d="M12 5c-7 0-11 7-11 7s4 7 11 7 11-7 11-7-4-7-11-7zm0 12a5 5 0 1 1 0-10 5 5 0 0 1 0 10zm0-8a3 3 0 1 0 0 6 3 3 0 0 0 0-6z"/></svg>`;
const ICON_VISIBILITY_OFF = `
<svg viewBox="0 0 24 24"><path d="M12 6c3.79 0 6.83 2.59 8.27 5-0.57 0.97-1.35 1.93-2.33 2.72l1.42 1.42c1.23-1.04 2.24-2.29 2.96-3.64C21 11 17 4 12 4c-1.52 0-2.94.29-4.22.8l1.66 1.66C10.25 6.17 11.1 6 12 6zm-9.27-3.73L1.46 3.54l3.06 3.06C3.06 7.86 1.98 9.37 1.73 9.8 3 12 7 19 12 19c1.74 0 3.35-.38 4.79-1.03l3.67 3.67 1.27-1.27L2.73 2.27zM7.11 8.79l1.7 1.7A3 3 0 0 0 12 15c.36 0 .7-.06 1.02-.17l1.65 1.65C13.86 16.82 12.95 17 12 17a5 5 0 0 1-4.89-8.21z"/></svg>`;

let pinHidden = true;
function renderEye(){ eyeBtn.innerHTML = pinHidden ? ICON_VISIBILITY : ICON_VISIBILITY_OFF; }
renderEye();

eyeBtn.addEventListener("click", () => {
  pinHidden = !pinHidden;
  pinInput.type = pinHidden ? "password" : "text";
  renderEye();
});


/* ============================================================
   ✅ Sede UI veloce (cache + niente flicker)
   ============================================================ */

const CACHE_TTL_MS = 7 * 24 * 60 * 60 * 1000; // 7 giorni
const cacheKey = `sedeInfo_${locationId}`;

function showSede(nome, indirizzo){
  sedeEl.textContent = `Sede: ${nome}`;
  indirizzoEl.textContent = indirizzo || "";
}

function showLoadingSede(){
  sedeEl.textContent = "Sede: Caricamento";
  sedeEl.classList.add("loading-dots");
  indirizzoEl.textContent = "";
  locTechEl.style.display = "none";
}

function showTechLocFallback(){
  locTechEl.textContent = `ID sede: ${locationId}`;
  locTechEl.style.display = "block";
}

async function initSedeUI(){
  showLoadingSede();

  // 1) prova cache istantanea
  try {
    const cached = JSON.parse(localStorage.getItem(cacheKey) || "null");
    if (cached && (Date.now() - cached.ts) < CACHE_TTL_MS) {
      sedeEl.classList.remove("loading-dots");
      showSede(cached.nomeSede || locationId, cached.indirizzo || "");
      // refresh in background comunque
    }
  } catch {}

  // 2) fetch dal backend
  try{
    const r = await fetch(`${WEBHOOK_URL}?action=sede&loc=${encodeURIComponent(locationId)}`, { cache: "no-store" });
    const j = await r.json();

    if (j.ok){
      sedeEl.classList.remove("loading-dots");
      const nome = j.nomeSede || locationId;
      const addr = j.indirizzo || "";
      showSede(nome, addr);

      // salva cache
      localStorage.setItem(cacheKey, JSON.stringify({
        ts: Date.now(),
        nomeSede: nome,
        indirizzo: addr
      }));
      return;
    }
    throw new Error("not ok");
  }catch(e){
    // 3) fallback: mostra ID tecnico solo se non ho nome umano
    sedeEl.classList.remove("loading-dots");
    showSede(locationId, "");
    showTechLocFallback();
  }
}
initSedeUI();


/* ============================================================
   ✅ Timbratura
   ============================================================ */

async function sendTimbro(type){
  const employeeId = document.getElementById("employeeId").value.trim();
  const pin = pinInput.value.trim();

  if(!employeeId || !pin){
    setStatus("Inserisci matricola e PIN.", "err");
    return;
  }

  setStatus("Recupero posizione… se neghi, timbro uguale.");

  const payloadBase = {
    employeeId,
    pin,
    type,
    locationId,
    deviceId: deviceId(),
    clientTs: new Date().toISOString()
  };

  const send = async (payload) => {
    setStatus("Invio timbro " + type + "…");

    const r = await fetch(WEBHOOK_URL, {
      method: "POST",
      headers: { "Content-Type": "text/plain;charset=utf-8" },
      body: JSON.stringify(payload)
    });

    const j = await r.json();

    if(!r.ok || !j.ok){
      throw new Error(j.error || ("HTTP " + r.status));
    }

    if (j.geofenceOk === false){
      setStatus(`Timbro registrato ⚠️ fuori area (${j.distanceM}m)`, "warn");
    } else if (j.geofenceOk === "UNKNOWN"){
      setStatus("Timbro registrato ✅ (GPS non disponibile)", "ok");
    } else {
      setStatus(`Timbro registrato ✅ (${type})`, "ok");
    }

    disableButtonsSafe();
  };

  if(!navigator.geolocation){
    return send({ ...payloadBase, lat:"NO_GPS", lon:"NO_GPS", accuracy:"" })
      .catch(e => setStatus("Errore invio: "+e.message, "err"));
  }

  navigator.geolocation.getCurrentPosition(
    pos => send({
      ...payloadBase,
      lat: pos.coords.latitude,
      lon: pos.coords.longitude,
      accuracy: pos.coords.accuracy
    }).catch(e => setStatus("Errore invio: "+e.message, "err")),

    err => send({
      ...payloadBase,
      lat: "GPS_DENIED",
      lon: "GPS_DENIED",
      accuracy: ""
    }).catch(e => setStatus("Errore invio: "+e.message, "err")),

    { enableHighAccuracy:true, timeout: 10000 }
  );
}

document.getElementById("btnIn").onclick = () => sendTimbro("IN");
document.getElementById("btnOut").onclick = () => sendTimbro("OUT");

// QR dedicati: stesso testo + stesso colore + micro-hint
if (presetMode === "IN" || presetMode === "OUT") {
  const isIn = presetMode === "IN";
  const cls = isIn ? "btn-in" : "btn-out";
  const label = isIn ? "ENTRATA" : "USCITA";

  buttonsEl.innerHTML = `<button id="autoBtn" class="${cls} btn-auto">${label}</button>`;
  document.getElementById("autoBtn").onclick = () => sendTimbro(presetMode);

  modeHintEl.style.display = "block";
  modeHintEl.textContent = isIn
    ? "Modalità QR Entrata attiva"
    : "Modalità QR Uscita attiva";
}
</script>
</body>
</html>
