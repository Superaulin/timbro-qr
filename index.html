<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Timbro Presenze</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap');

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Poppins', sans-serif;
    }

    body {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      background: linear-gradient(135deg, #1e3665, #008553);
      padding: 16px;
    }

    .login-container {
      background: white;
      padding: 24px 22px 20px;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.25);
      width: 100%;
      max-width: 400px;
      text-align: center;
    }

    .logo {
      width: 200px;
      height: auto;
      object-fit: contain;
      margin-bottom: 12px;
    }

    h2 {
      font-size: 22px;
      margin-bottom: 4px;
    }

    .subtitle {
      font-size: 13px;
      color: #555;
      margin-bottom: 4px;
    }

    .sede-label {
      font-size: 13px;
      font-weight: 600;
      color: #1e3665;
      margin-top: 4px;
    }

    .sede-indirizzo {
      font-size: 11px;
      color: #666;
      margin-bottom: 6px;
      min-height: 14px;
    }

    .mode-label {
      font-size: 11px;
      margin-bottom: 10px;
      color: #444;
    }

    .mode-label span {
      font-weight: 600;
    }

    form {
      text-align: left;
      margin-top: 6px;
    }

    .input-group {
      margin-bottom: 12px;
    }

    label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 4px;
    }

    input[type="text"],
    input[type="password"],
    input[type="number"] {
      width: 100%;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 14px;
      outline: none;
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    input:focus {
      border-color: #1e3665;
      box-shadow: 0 0 0 2px rgba(30,54,101,0.15);
    }

    .password-wrapper {
      display: flex;
      align-items: center;
      border-radius: 6px;
      border: 1px solid #ccc;
      padding-right: 4px;
      background: #f9f9f9;
    }

    .password-wrapper input {
      border: none;
      background: transparent;
      box-shadow: none;
      padding-right: 0;
    }

    .password-wrapper input:focus {
      border: none;
      box-shadow: none;
    }

    .toggle-password {
      border: none;
      background: transparent;
      cursor: pointer;
      padding: 0 6px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .toggle-password svg {
      width: 18px;
      height: 18px;
      fill: #555;
    }

    .toggle-password:hover svg {
      fill: #000;
    }

    .buttons-row {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }

    .login-button {
      flex: 1;
      padding: 10px;
      font-size: 15px;
      font-weight: 600;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      transition: transform 0.1s, box-shadow 0.1s, background-color 0.15s;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .login-button:disabled {
      opacity: 0.6;
      cursor: default;
      box-shadow: none;
      transform: none;
    }

    .login-button:active:not(:disabled) {
      transform: translateY(1px);
      box-shadow: 0 3px 6px rgba(0,0,0,0.2);
    }

    .btn-in {
      background: #008553;
      color: white;
      box-shadow: 0 4px 8px rgba(0,133,83,0.35);
    }

    .btn-in:hover:not(:disabled) {
      background: #006b42;
    }

    .btn-out {
      background: #c62828;
      color: white;
      box-shadow: 0 4px 8px rgba(198,40,40,0.35);
    }

    .btn-out:hover:not(:disabled) {
      background: #a31818;
    }

    .status {
      margin-top: 10px;
      font-size: 12px;
      min-height: 32px;
      text-align: left;
      white-space: pre-line;
    }

    .status.ok {
      color: #006b42;
    }

    .status.err {
      color: #b71c1c;
    }

    .gps-note {
      font-size: 10px;
      color: #777;
      margin-top: 4px;
      text-align: left;
    }

    .footer-tech {
      margin-top: 8px;
      font-size: 9px;
      color: #999;
      text-align: right;
    }

    .footer-tech code {
      font-size: 9px;
      background: #f0f0f0;
      padding: 1px 3px;
      border-radius: 3px;
    }

    @media (max-width: 420px) {
      .login-container {
        padding: 18px 16px 16px;
      }
      h2 { font-size: 20px; }
    }
  </style>
</head>
<body>
  <div class="login-container">
    <img src="img/logo.png" alt="Logo Aziendale" class="logo">

    <h2>Timbro Presenze</h2>
    <p class="subtitle">Registrazione ingresso / uscita</p>

    <p class="sede-label" id="sedeName">Sede: …</p>
    <p class="sede-indirizzo" id="sedeAddress"></p>
    <p class="mode-label" id="modeLabel">Modalità standard (scelta manuale)</p>

    <form id="timbroForm" autocomplete="off">
      <div class="input-group">
        <label for="employeeId">ID dipendente</label>
        <input type="text" id="employeeId" name="employeeId" placeholder="Es. 1001" inputmode="numeric">
      </div>

      <div class="input-group">
        <label for="pin">PIN</label>
        <div class="password-wrapper">
          <!-- QUI la modifica: inputmode="numeric" pattern="[0-9]*" -->
          <input type="password" id="pin" name="pin" placeholder="PIN numerico"
                 inputmode="numeric" pattern="[0-9]*">
          <button type="button" class="toggle-password" id="togglePin" aria-label="Mostra/Nascondi PIN">
            <svg id="eyeIcon" viewBox="0 0 24 24">
              <path d="M12 5C7 5 2.73 8.11 1 12c1.73 3.89 6 7 11 7s9.27-3.11 11-7c-1.73-3.89-6-7-11-7zm0 12a5 5 0 1 1 0-10 5 5 0 0 1 0 10zm0-8a3 3 0 1 0 .002 6.002A3 3 0 0 0 12 9z"/>
            </svg>
          </button>
        </div>
      </div>

      <div class="buttons-row">
        <button type="button" class="login-button btn-in" id="btnIn">Entrata</button>
        <button type="button" class="login-button btn-out" id="btnOut">Uscita</button>
      </div>
    </form>

    <div class="status" id="statusMsg"></div>
    <div class="gps-note">
      La posizione viene usata solo per verificare che il timbro avvenga in sede.<br>
      Se neghi il GPS, il timbro viene registrato ma marcato come anomalia.
    </div>

    <div class="footer-tech">
      QR: <code>loc</code> / <code>mode</code> · v2 UI
    </div>
  </div>

  <script>
    const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbw3UYl68d61ym-mPVrgh1QyphQaaWotOSgrczzNGRS3KD9euIpDg-nv60Ns06vRCfLx/exec";

    document.addEventListener("DOMContentLoaded", () => {
      const params = new URLSearchParams(window.location.search);
      const locParam = params.get("loc") || "";
      const modeParam = (params.get("mode") || "").toUpperCase();

      const sedeNameEl = document.getElementById("sedeName");
      const sedeAddressEl = document.getElementById("sedeAddress");
      const modeLabelEl = document.getElementById("modeLabel");
      const statusEl = document.getElementById("statusMsg");

      const employeeIdInput = document.getElementById("employeeId");
      const pinInput = document.getElementById("pin");
      const btnIn = document.getElementById("btnIn");
      const btnOut = document.getElementById("btnOut");
      const togglePinBtn = document.getElementById("togglePin");
      const eyeIcon = document.getElementById("eyeIcon");

      let currentMode = null;
      let sedeLoaded = false;

      function disableButtons(flag) {
        if (btnIn) btnIn.disabled = flag;
        if (btnOut) btnOut.disabled = flag;
      }

      function setStatus(msg, isError) {
        statusEl.textContent = msg || "";
        statusEl.classList.remove("ok", "err");
        if (!msg) return;
        statusEl.classList.add(isError ? "err" : "ok");
      }

      if (location.protocol === "file:") {
        setStatus("La pagina è aperta in locale (file://).\nPer timbrare devi usarla da un indirizzo https (es. GitHub Pages o Netlify).", true);
        disableButtons(true);
        return;
      }

      function applyMode(mode) {
        currentMode = mode;

        btnIn.style.display = "inline-flex";
        btnOut.style.display = "inline-flex";

        if (mode === "IN") {
          modeLabelEl.innerHTML = 'Modalità QR: <span>Entrata attiva</span>';
          btnOut.style.display = "none";
        } else if (mode === "OUT") {
          modeLabelEl.innerHTML = 'Modalità QR: <span>Uscita attiva</span>';
          btnIn.style.display = "none";
        } else {
          modeLabelEl.textContent = "Modalità standard (scelta manuale)";
        }
      }

      applyMode(modeParam === "IN" || modeParam === "OUT" ? modeParam : null);

      togglePinBtn.addEventListener("click", () => {
        if (pinInput.type === "password") {
          pinInput.type = "text";
          eyeIcon.innerHTML = '<path d="M12 5C7 5 2.73 8.11 1 12c.37.83.86 1.61 1.45 2.33L3 15.78 4.22 17l1.9-1.9A11.5 11.5 0 0 0 12 19c5 0 9.27-3.11 11-7-.64-1.44-1.64-2.76-2.88-3.86L19.78 9 18.56 10.22l-1.4 1.4A4.98 4.98 0 0 1 12 17a4.96 4.96 0 0 1-3.54-1.46L6.22 15.3 5 14.08l1.02-1.02A6.96 6.96 0 0 1 5.05 9.0L6.5 7.55A8 8 0 0 1 12 7c.69 0 1.35.09 1.97.26L15.45 5.8A9.87 9.87 0 0 0 12 5z"/>';
        } else {
          pinInput.type = "password";
          eyeIcon.innerHTML = '<path d="M12 5C7 5 2.73 8.11 1 12c1.73 3.89 6 7 11 7s9.27-3.11 11-7c-1.73-3.89-6-7-11-7zm0 12a5 5 0 1 1 0-10 5 5 0 0 1 0 10zm0-8a3 3 0 1 0 .002 6.002A3 3 0 0 0 12 9z"/>';
        }
      });

      if (!locParam) {
        setStatus("QR non valido: parametro 'loc' mancante.", true);
        sedeNameEl.textContent = "Sede: errore";
        disableButtons(true);
      } else {
        sedeNameEl.textContent = "Sede: caricamento…";
        fetch(WEBAPP_URL + "?action=sede&loc=" + encodeURIComponent(locParam))
          .then(r => r.json())
          .then(data => {
            if (!data.ok) {
              setStatus("Errore nel recupero della sede: " + (data.error || "sconosciuto"), true);
              sedeNameEl.textContent = "Sede: errore";
              disableButtons(true);
              return;
            }
            sedeLoaded = true;
            const nome = data.nomeSede || data.locationId;
            const indirizzo = data.indirizzo || "";

            sedeNameEl.textContent = "Sede: " + nome;
            sedeAddressEl.textContent = indirizzo;
          })
          .catch(err => {
            setStatus("Errore rete nel recupero sede: " + err.message, true);
            sedeNameEl.textContent = "Sede: errore rete";
            disableButtons(true);
          });
      }

      function getPosition() {
        if (!navigator.geolocation) {
          return Promise.resolve({
            lat: "GPS_DENIED",
            lon: "",
            accuracy: ""
          });
        }

        return new Promise(resolve => {
          navigator.geolocation.getCurrentPosition(
            pos => {
              resolve({
                lat: pos.coords.latitude,
                lon: pos.coords.longitude,
                accuracy: pos.coords.accuracy
              });
            },
            err => {
              resolve({
                lat: "GPS_DENIED",
                lon: "",
                accuracy: ""
              });
            },
            {
              enableHighAccuracy: true,
              timeout: 10000,
              maximumAge: 0
            }
          );
        });
      }

      async function sendTimbro(type) {
        const employeeId = (employeeIdInput.value || "").trim();
        const pin = (pinInput.value || "").trim();

        if (!employeeId || !pin) {
          setStatus("Inserisci ID dipendente e PIN.", true);
          return;
        }

        if (!locParam) {
          setStatus("Parametro 'loc' mancante (QR non valido).", true);
          return;
        }

        if (!sedeLoaded) {
          setStatus("Attendi caricamento sede…", true);
          return;
        }

        if (currentMode === "IN" && type === "OUT") {
          setStatus("Questo QR è solo per l'entrata.", true);
          return;
        }
        if (currentMode === "OUT" && type === "IN") {
          setStatus("Questo QR è solo per l'uscita.", true);
          return;
        }

        disableButtons(true);
        setStatus("Invio timbro " + type + " in corso…", false);

        try {
          const pos = await getPosition();
          const payload = {
            employeeId,
            pin,
            type,
            locationId: locParam,
            lat: pos.lat,
            lon: pos.lon,
            accuracy: pos.accuracy,
            deviceId: navigator.userAgent.slice(0, 120),
            clientTs: new Date().toISOString()
          };

          console.log("WEBAPP_URL =", WEBAPP_URL);
          console.log("Payload timbro", payload);

          const resp = await fetch(WEBAPP_URL, {
            method: "POST",
            headers: { "Content-Type": "text/plain;charset=utf-8" },
            body: JSON.stringify(payload)
          });

          const data = await resp.json().catch(() => ({}));

          if (!resp.ok || !data.ok) {
            const msg = (data && data.error) ? data.error : ("HTTP " + resp.status);
            setStatus("Errore timbro " + type + ": " + msg, true);
            disableButtons(false);
            return;
          }

          const serverTs = data.serverTs ? new Date(data.serverTs) : null;
          let msg = "Timbro " + type + " registrato correttamente.";
          if (serverTs && !isNaN(serverTs.getTime())) {
            const hh = String(serverTs.getHours()).padStart(2, "0");
            const mm = String(serverTs.getMinutes()).padStart(2, "0");
            msg += "\nOra server: " + hh + ":" + mm;
          }

          if (data.geofenceOk === false) {
            msg += "\nATTENZIONE: timbro fuori dall'area sede.";
          } else if (data.geofenceOk === "UNKNOWN") {
            msg += "\nNota: GPS non disponibile / negato.";
          }

          setStatus(msg, false);
          pinInput.value = "";
        } catch (err) {
          console.error("Errore fetch timbro:", err);
          setStatus("Errore invio: " + err.message, true);
        } finally {
          disableButtons(false);
        }
      }

      btnIn.addEventListener("click", () => sendTimbro("IN"));
      btnOut.addEventListener("click", () => sendTimbro("OUT"));
    });
  </script>
</body>
</html>
