<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Timbro QR v2</title>
  <style>
    body{
      font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
      max-width:520px;margin:0 auto;padding:18px;
    }
    h1{font-size:22px;margin:0 0 8px;}
    .box{background:#f6f6f6;border-radius:14px;padding:14px;margin:10px 0;}
    input,button{
      width:100%;padding:12px;font-size:16px;border-radius:10px;
      border:1px solid #ddd;box-sizing:border-box;
    }
    button{
      border:none;margin-top:8px;cursor:pointer;font-weight:700;
      color:white;
    }
    .row{display:flex;gap:10px;}
    .row button{flex:1;}

    /* ‚úÖ Colori timbratura */
    .btn-in{ background:#1f9d55; }    /* verde */
    .btn-out{ background:#d64545; }   /* rosso */
    .btn-in:disabled, .btn-out:disabled, .btn-auto:disabled { opacity:0.6; cursor:not-allowed; }

    .small{font-size:12px;opacity:.7}
    .ok{color:green;font-weight:800}
    .err{color:#b00020;font-weight:800}
    .warn{color:#c27b00;font-weight:800}

    /* ‚úÖ PIN con occhietto */
    .pin-wrap{
      position:relative;
      display:flex;
      align-items:center;
    }
    .pin-wrap input{
      padding-right:44px; /* spazio per occhio */
    }
    .eye-btn{
      position:absolute;
      right:8px;
      top:50%;
      transform:translateY(-50%);
      width:32px;height:32px;
      border-radius:8px;
      border:1px solid #ddd;
      background:white;
      color:#333;
      font-size:16px;
      line-height:30px;
      cursor:pointer;
      display:flex;align-items:center;justify-content:center;
      user-select:none;
    }
  </style>
</head>
<body>
  <h1>Timbratura</h1>
  <div class="small" id="sede"></div>
  <div class="small" id="modeHint" style="margin-top:4px; display:none;"></div>

  <div class="box">
    <label>Matricola</label>
    <input id="employeeId" inputmode="numeric" placeholder="es. 1042"/>

    <label style="margin-top:6px;display:block;">PIN</label>
    <div class="pin-wrap">
      <input id="pin" inputmode="numeric" type="password" placeholder="4 cifre"/>
      <button type="button" id="eyeBtn" class="eye-btn" aria-label="Mostra/Nascondi PIN">üëÅÔ∏è</button>
    </div>
  </div>

  <div class="box row" id="buttons">
    <button id="btnIn" class="btn-in">ENTRATA</button>
    <button id="btnOut" class="btn-out">USCITA</button>
  </div>

  <div class="box small" id="status">Pronto.</div>

<script>
/** ‚úÖ Webhook tua, gi√† dentro */
const WEBHOOK_URL = "https://script.google.com/macros/s/AKfycbw3UYl68d61ym-mPVrgh1QyphQaaWotOSgrczzNGRS3KD9euIpDg-nv60Ns06vRCfLx/exec";

const statusEl = document.getElementById("status");
const sedeEl = document.getElementById("sede");
const buttonsEl = document.getElementById("buttons");
const modeHintEl = document.getElementById("modeHint");
const pinInput = document.getElementById("pin");
const eyeBtn = document.getElementById("eyeBtn");

function getParam(name){
  const u = new URL(location.href);
  return u.searchParams.get(name);
}

const locationId = getParam("loc") || "UNKNOWN_SEDE";
const presetMode = getParam("mode"); // opzionale: IN/OUT preimpostato

sedeEl.textContent = "Sede: " + locationId;

function deviceId(){
  return btoa(navigator.userAgent).slice(0,32);
}

function setStatus(msg, cls=""){
  statusEl.className = "box small " + cls;
  statusEl.textContent = msg;
}

function disableButtonsSafe(){
  const bIn = document.getElementById("btnIn");
  const bOut = document.getElementById("btnOut");
  const bAuto = document.getElementById("autoBtn");
  if (bIn) bIn.disabled = true;
  if (bOut) bOut.disabled = true;
  if (bAuto) bAuto.disabled = true;
}

/* ‚úÖ Occhietto PIN */
eyeBtn.addEventListener("click", () => {
  const isHidden = pinInput.type === "password";
  pinInput.type = isHidden ? "text" : "password";
  eyeBtn.textContent = isHidden ? "üôà" : "üëÅÔ∏è";
});

async function sendTimbro(type){
  const employeeId = document.getElementById("employeeId").value.trim();
  const pin = pinInput.value.trim();

  if(!employeeId || !pin){
    setStatus("Inserisci matricola e PIN.", "err");
    return;
  }

  setStatus("Recupero posizione‚Ä¶ se neghi, timbro uguale.");

  const payloadBase = {
    employeeId,
    pin,
    type,
    locationId,
    deviceId: deviceId(),
    clientTs: new Date().toISOString()
  };

  // FIX CORS: text/plain => niente preflight
  const send = async (payload) => {
    setStatus("Invio timbro " + type + "‚Ä¶");

    const r = await fetch(WEBHOOK_URL, {
      method: "POST",
      headers: { "Content-Type": "text/plain;charset=utf-8" },
      body: JSON.stringify(payload)
    });

    const j = await r.json();

    if(!r.ok || !j.ok){
      throw new Error(j.error || ("HTTP " + r.status));
    }

    if (j.geofenceOk === false){
      setStatus(`Timbro registrato ‚ö†Ô∏è fuori area (${j.distanceM}m)`, "warn");
    } else if (j.geofenceOk === "UNKNOWN"){
      setStatus("Timbro registrato ‚úÖ (GPS non disponibile)", "ok");
    } else {
      setStatus(`Timbro registrato ‚úÖ (${type})`, "ok");
    }

    disableButtonsSafe();
  };

  if(!navigator.geolocation){
    return send({ ...payloadBase, lat:"NO_GPS", lon:"NO_GPS", accuracy:"" })
      .catch(e => setStatus("Errore invio: "+e.message, "err"));
  }

  navigator.geolocation.getCurrentPosition(
    pos => send({
      ...payloadBase,
      lat: pos.coords.latitude,
      lon: pos.coords.longitude,
      accuracy: pos.coords.accuracy
    }).catch(e => setStatus("Errore invio: "+e.message, "err")),

    err => send({
      ...payloadBase,
      lat: "GPS_DENIED",
      lon: "GPS_DENIED",
      accuracy: ""
    }).catch(e => setStatus("Errore invio: "+e.message, "err")),

    { enableHighAccuracy:true, timeout: 10000 }
  );
}

document.getElementById("btnIn").onclick = () => sendTimbro("IN");
document.getElementById("btnOut").onclick = () => sendTimbro("OUT");

// ‚úÖ QR dedicati: stesso testo + stesso colore + micro-hint
if (presetMode === "IN" || presetMode === "OUT") {
  const isIn = presetMode === "IN";
  const cls = isIn ? "btn-in" : "btn-out";
  const label = isIn ? "ENTRATA" : "USCITA";

  buttonsEl.innerHTML = `<button id="autoBtn" class="${cls} btn-auto">${label}</button>`;
  document.getElementById("autoBtn").onclick = () => sendTimbro(presetMode);

  modeHintEl.style.display = "block";
  modeHintEl.textContent = isIn
    ? "Modalit√† QR Entrata attiva"
    : "Modalit√† QR Uscita attiva";
}
</script>
</body>
</html>
