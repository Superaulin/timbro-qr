<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Timbro Presenze</title>

  <!-- CSS base + tema cliente -->
  <link rel="stylesheet" href="css/base.css" />
  <link rel="stylesheet" href="css/tema-cliente.css" />
</head>
<body>
  <!-- BOX BIANCO CENTRALE -->
  <div class="card login-container">
    <!-- logo dimensionato per la pagina timbro -->
    <img src="img/logo.png" alt="Logo Aziendale" class="logo-main" />

    <!-- link alla lista sedi, centrato sotto il logo -->
    <a href="sedi.html" class="back-link">← Torna alla lista sedi</a>

    <h2>Timbro Presenze</h2>
    <p class="subtitle">Registrazione ingresso / uscita</p>

    <p class="sede-label" id="sedeName">Sede: caricamento…</p>
    <p class="sede-indirizzo" id="sedeAddress"></p>
    <p class="mode-label" id="modeLabel">Modalità standard (scelta manuale)</p>

    <form id="timbroForm" autocomplete="off">
      <div class="input-group">
        <label for="employeeId">ID dipendente</label>
        <input
          type="text"
          id="employeeId"
          name="employeeId"
          placeholder="Es. 1001"
          inputmode="numeric"
        />
      </div>

      <div class="input-group">
        <label for="pin">PIN</label>
        <div class="password-wrapper">
          <input
            type="password"
            id="pin"
            name="pin"
            placeholder="PIN numerico"
            inputmode="numeric"
            pattern="[0-9]*"
          />
          <button
            type="button"
            class="toggle-password"
            id="togglePin"
            aria-label="Mostra/Nascondi PIN"
          >
            <svg id="eyeIcon" viewBox="0 0 24 24">
              <path
                d="M12 5C7 5 2.73 8.11 1 12c1.73 3.89 6 7 11 7s9.27-3.11 11-7c-1.73-3.89-6-7-11-7zm0 12a5 5 0 1 1 0-10 5 5 0 0 1 0 10zm0-8a3 3 0 1 0 .002 6.002A3 3 0 0 0 12 9z"
              />
            </svg>
          </button>
        </div>
      </div>

      <div class="buttons-row">
        <button type="button" class="login-button btn-in" id="btnIn">
          Entrata
        </button>
        <button type="button" class="login-button btn-out" id="btnOut">
          Uscita
        </button>
      </div>
    </form>

    <div class="status" id="statusMsg"></div>

    <div class="gps-note">
      La posizione viene usata solo per verificare che il timbro avvenga in
      sede.<br />
      Se neghi il GPS, il timbro viene registrato ma marcato come anomalia.
    </div>

    <div class="footer-tech">
      QR: <code>loc</code> / <code>mode</code> · v2 UI
    </div>
  </div>

  <script>
    const WEBAPP_URL =
      "https://script.google.com/macros/s/AKfycbxaiiuQovXIT44GjKBpPXMtMSDXAg51M1lCgi-fbFnGkBTqE5y4PnnaiBQC-HiYGpkC/exec";

    document.addEventListener("DOMContentLoaded", () => {
      const params = new URLSearchParams(window.location.search);
      const locParam = params.get("loc") || "";
      const modeParam = (params.get("mode") || "").toUpperCase();

      const sedeNameEl = document.getElementById("sedeName");
      const sedeAddressEl = document.getElementById("sedeAddress");
      const modeLabelEl = document.getElementById("modeLabel");
      const statusEl = document.getElementById("statusMsg");

      const employeeIdInput = document.getElementById("employeeId");
      const pinInput = document.getElementById("pin");
      const btnIn = document.getElementById("btnIn");
      const btnOut = document.getElementById("btnOut");
      const togglePinBtn = document.getElementById("togglePin");
      const eyeIcon = document.getElementById("eyeIcon");

      let currentMode = null;
      let sedeLoaded = false;

      function disableButtons(flag) {
        if (btnIn) btnIn.disabled = flag;
        if (btnOut) btnOut.disabled = flag;
      }

      function setStatus(msg, isError) {
        statusEl.textContent = msg || "";
        statusEl.classList.remove("ok", "err");
        if (!msg) return;
        statusEl.classList.add(isError ? "err" : "ok");
      }

      if (location.protocol === "file:") {
        setStatus(
          "La pagina è aperta in locale (file://).\nPer timbrare devi usarla da un indirizzo https (es. GitHub Pages o Netlify).",
          true
        );
        disableButtons(true);
        return;
      }

      function applyMode(mode) {
        currentMode = mode;

        btnIn.style.display = "inline-flex";
        btnOut.style.display = "inline-flex";

        if (mode === "IN") {
          modeLabelEl.innerHTML =
            'Modalità QR: <span>Entrata attiva</span>';
          btnOut.style.display = "none";
        } else if (mode === "OUT") {
          modeLabelEl.innerHTML =
            'Modalità QR: <span>Uscita attiva</span>';
          btnIn.style.display = "none";
        } else {
          modeLabelEl.textContent =
            "Modalità standard (scelta manuale)";
        }
      }

      applyMode(
        modeParam === "IN" || modeParam === "OUT" ? modeParam : null
      );

      togglePinBtn.addEventListener("click", () => {
        if (pinInput.type === "password") {
          pinInput.type = "text";
          eyeIcon.innerHTML =
            '<path d="M12 5C7 5 2.73 8.11 1 12c.37.83.86 1.61 1.45 2.33L3 15.78 4.22 17l1.9-1.9A11.5 11.5 0 0 0 12 19c5 0 9.27-3.11 11-7-.64-1.44-1.64-2.76-2.88-3.86L19.78 9 18.56 10.22l-1.4 1.4A4.98 4.98 0 0 1 12 17a4.96 4.96 0 0 1-3.54-1.46L6.22 15.3 5 14.08l1.02-1.02A6.96 6.96 0 0 1 5.05 9.0L6.5 7.55A8 8 0 0 1 12 7c.69 0 1.35.09 1.97.26L15.45 5.8A9.87 9.87 0 0 0 12 5z"/>';
        } else {
          pinInput.type = "password";
          eyeIcon.innerHTML =
            '<path d="M12 5C7 5 2.73 8.11 1 12c1.73 3.89 6 7 11 7s9.27-3.11 11-7c-1.73-3.89-6-7-11-7zm0 12a5 5 0 1 1 0-10 5 5 0 0 1 0 10zm0-8a3 3 0 1 0 .002 6.002A3 3 0 0 0 12 9z"/>';
        }
      });

      if (!locParam) {
        setStatus("QR non valido: parametro 'loc' mancante.", true);
        sedeNameEl.textContent = "Sede: errore";
        disableButtons(true);
      } else {
        sedeNameEl.textContent = "Sede: caricamento…";
        fetch(WEBAPP_URL + "?action=sede&loc=" + encodeURIComponent(locParam))
          .then((r) => r.json())
          .then((data) => {
            if (!data.ok) {
              setStatus(
                "Errore nel recupero della sede: " +
                  (data.error || "sconosciuto"),
                true
              );
              sedeNameEl.textContent = "Sede: errore";
              disableButtons(true);
              return;
            }
            sedeLoaded = true;
            const nome = data.nomeSede || data.locationId;
            const indirizzo = data.indirizzo || "";

            sedeNameEl.textContent = "Sede: " + nome;
            sedeAddressEl.textContent = indirizzo;
          })
          .catch((err) => {
            setStatus(
              "Errore rete nel recupero sede: " + err.message,
              true
            );
            sedeNameEl.textContent = "Sede: errore rete";
            disableButtons(true);
          });
      }

      function getPosition() {
        if (!navigator.geolocation) {
          return Promise.resolve({
            lat: "GPS_DENIED",
            lon: "",
            accuracy: "",
          });
        }

        return new Promise((resolve) => {
          navigator.geolocation.getCurrentPosition(
            (pos) => {
              resolve({
                lat: pos.coords.latitude,
                lon: pos.coords.longitude,
                accuracy: pos.coords.accuracy,
              });
            },
            () => {
              resolve({
                lat: "GPS_DENIED",
                lon: "",
                accuracy: "",
              });
            },
            {
              enableHighAccuracy: true,
              timeout: 10000,
              maximumAge: 0,
            }
          );
        });
      }

      async function sendTimbro(type) {
        const employeeId = (employeeIdInput.value || "").trim();
        const pin = (pinInput.value || "").trim();

        if (!employeeId || !pin) {
          setStatus("Inserisci ID dipendente e PIN.", true);
          return;
        }

        if (!locParam) {
          setStatus("Parametro 'loc' mancante (QR non valido).", true);
          return;
        }

        if (!sedeLoaded) {
          setStatus("Attendi caricamento sede…", true);
          return;
        }

        if (currentMode === "IN" && type === "OUT") {
          setStatus("Questo QR è solo per l'entrata.", true);
          return;
        }
        if (currentMode === "OUT" && type === "IN") {
          setStatus("Questo QR è solo per l'uscita.", true);
          return;
        }

        disableButtons(true);
        setStatus("Invio timbro " + type + " in corso…", false);

        try {
          const pos = await getPosition();
          const payload = {
            employeeId,
            pin,
            type,
            locationId: locParam,
            lat: pos.lat,
            lon: pos.lon,
            accuracy: pos.accuracy,
            deviceId: navigator.userAgent.slice(0, 120),
            clientTs: new Date().toISOString(),
          };

          const resp = await fetch(WEBAPP_URL, {
            method: "POST",
            headers: { "Content-Type": "text/plain;charset=utf-8" },
            body: JSON.stringify(payload),
          });

          const data = await resp.json().catch(() => ({}));

          if (!resp.ok || !data.ok) {
            const msg =
              data && data.error ? data.error : "HTTP " + resp.status;
            setStatus("Errore timbro " + type + ": " + msg, true);
            disableButtons(false);
            return;
          }

          const serverTs = data.serverTs ? new Date(data.serverTs) : null;
          let msg = "Timbro " + type + " registrato correttamente.";
          if (serverTs && !isNaN(serverTs.getTime())) {
            const hh = String(serverTs.getHours()).padStart(2, "0");
            const mm = String(serverTs.getMinutes()).padStart(2, "0");
            msg += "\nOra server: " + hh + ":" + mm;
          }

          if (data.geofenceOk === false) {
            msg += "\nATTENZIONE: timbro fuori dall'area sede.";
          } else if (data.geofenceOk === "UNKNOWN") {
            msg += "\nNota: GPS non disponibile / negato.";
          }

          setStatus(msg, false);
          pinInput.value = "";
        } catch (err) {
          setStatus("Errore invio: " + err.message, true);
        } finally {
          disableButtons(false);
        }
      }

      btnIn.addEventListener("click", () => sendTimbro("IN"));
      btnOut.addEventListener("click", () => sendTimbro("OUT"));
    });
  </script>
</body>
</html>
