<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sedi – Timbro Presenze</title>

  <link rel="stylesheet" href="css/base.css">
  <link rel="stylesheet" href="css/tema-cliente.css">
</head>
<body class="page-sedi">
  <div class="card card-sedi">
    <header class="sedi-header">
      <img src="img/logo.png" alt="Logo Aziendale" class="logo-sedi">
      <div class="sedi-header-text">
        <h1>Seleziona la sede</h1>
        <p>
          Scegli la sede o il cantiere in cui ti trovi per aprire la pagina di timbratura.
          Puoi salvare la pagina tra i preferiti per usarla più velocemente.
        </p>
      </div>
    </header>

    <hr class="sedi-divider">

    <div id="sediContainer" class="sedi-list">
      <p class="sedi-loading">Caricamento sedi in corso…</p>
    </div>
  </div>

  <script>
    const WEBAPP_URL =
      "https://script.google.com/macros/s/AKfycbxaiiuQovXIT44GjKBpPXMtMSDXAg51M1lCgi-fbFnGkBTqE5y4PnnaiBQC-HiYGpkC/exec";

    const TIMBRO_PAGE = "index.html";

    // ------------ utilità grouping -------------
    function getGroupNameFromSede(sede) {
      const regione   = (sede.regione  || "").trim();
      const provincia = (sede.provincia || "").trim();
      const comune    = (sede.comune   || "").trim();

      if (comune && provincia) return `${comune} (${provincia})`;
      if (provincia && regione) return `${provincia} – ${regione}`;
      if (provincia) return provincia;
      if (regione) return regione;

      // fallback vecchio: ultima parte dell'indirizzo
      if (sede.indirizzo) {
        const parts = sede.indirizzo.split(",");
        return parts[parts.length - 1].trim() || "Altro";
      }
      return "Altro";
    }

    function renderSedi(sedi) {
      const container = document.getElementById("sediContainer");
      container.innerHTML = "";

      if (!Array.isArray(sedi) || sedi.length === 0) {
        container.innerHTML =
          "<p>Nessuna sede configurata.</p>";
        return;
      }

      // raggruppa per gruppo (es. comune/provincia)
      const groups = {};
      for (const sede of sedi) {
        if (!sede || !sede.locationId) continue;
        if (sede.attivo === false || sede.attivo === "FALSE") continue;

        const groupName = getGroupNameFromSede(sede);
        if (!groups[groupName]) groups[groupName] = [];
        groups[groupName].push(sede);
      }

      const groupNames = Object.keys(groups).sort((a, b) =>
        a.localeCompare(b, "it", { sensitivity: "base" })
      );

      for (const gName of groupNames) {
        const g = groups[gName];

        const groupEl = document.createElement("section");
        groupEl.className = "sedi-group";

        const h = document.createElement("h2");
        h.className = "sedi-group-title";
        h.textContent = gName;
        groupEl.appendChild(h);

        const listEl = document.createElement("div");
        listEl.className = "sedi-group-list";

        g.forEach(sede => {
          const card = document.createElement("article");
          card.className = "sedi-card";

          const body = document.createElement("div");
          body.className = "sedi-card-body";

          const nameEl = document.createElement("div");
          nameEl.className = "sedi-name";
          nameEl.textContent = sede.nomeSede || sede.locationId;

          // ===== NUOVA FORMATTAZIONE INDIRIZZO =====
          const indirizzo = (sede.indirizzo || "").trim();
          const citta     = (sede.citta || "").trim();     // campo "città" nel foglio
          const cap       = (sede.cap || "").toString().trim();
          const comune    = (sede.comune || "").trim();
          const provincia = (sede.provincia || "").trim();
          const regione   = (sede.regione || "").trim();

          // Riga 2: Via Francia 120 · Guasticce
          const addrLine1 = document.createElement("div");
          addrLine1.className = "sedi-address";
          const line1Parts = [];
          if (indirizzo) line1Parts.push(indirizzo);
          if (citta)     line1Parts.push(citta);
          addrLine1.textContent = line1Parts.join(" · ");

          // Riga 3: 57014 Collesalvetti
          const addrLine2 = document.createElement("div");
          addrLine2.className = "sedi-address";
          const line2Parts = [];
          if (cap)    line2Parts.push(cap);
          if (comune) line2Parts.push(comune);
          addrLine2.textContent = line2Parts.join(" ");

          // Riga 4: Livorno · Toscana
          const metaEl = document.createElement("div");
          metaEl.className = "sedi-meta";
          const metaParts = [];
          if (provincia) metaParts.push(provincia);
          if (regione)   metaParts.push(regione);
          metaEl.textContent = metaParts.join(" · ");
          // ===== FINE NUOVA FORMATTAZIONE =====

          body.appendChild(nameEl);
          if (addrLine1.textContent) body.appendChild(addrLine1);
          if (addrLine2.textContent) body.appendChild(addrLine2);
          if (metaEl.textContent)    body.appendChild(metaEl);

          const btn = document.createElement("a");
          btn.className = "sedi-btn";
          btn.textContent = "Apri timbro";
          btn.href = `${TIMBRO_PAGE}?loc=${encodeURIComponent(sede.locationId)}`;

          card.appendChild(body);
          card.appendChild(btn);

          listEl.appendChild(card);
        });

        groupEl.appendChild(listEl);
        container.appendChild(groupEl);
      }
    }

    async function loadSedi() {
      const container = document.getElementById("sediContainer");
      try {
        const res = await fetch(WEBAPP_URL + "?action=sedi");
        const data = await res.json();
        if (!res.ok || !data.ok) {
          throw new Error(data && data.error ? data.error : "Risposta non valida");
        }
        renderSedi(data.sedi || []);
      } catch (err) {
        console.error("Errore caricamento sedi:", err);
        container.innerHTML =
          '<p class="sedi-error">Errore nel caricamento delle sedi.</p>';
      }
    }

    document.addEventListener("DOMContentLoaded", loadSedi);
  </script>
</body>
</html>
