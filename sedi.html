<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sedi – Timbro Facile</title>

  <link rel="stylesheet" href="css/base.css" />
  <link rel="stylesheet" href="css/tema-cliente.css" />
</head>
<body>
  <!-- card centrale con logo + elenco sedi -->
  <div class="card">
    <!-- header con logo più piccolo -->
    <div class="sedi-header">
      <img src="img/logo.png" alt="Logo Aziendale" class="logo-sedi" />
      <div class="sedi-header-text">
        <h1>Seleziona la sede</h1>
        <p>
          Scegli la sede o il cantiere in cui ti trovi per aprire la pagina di timbratura.
          Puoi salvare la pagina tra i preferiti per usarla più velocemente.
        </p>
      </div>
    </div>

    <hr style="margin: 8px 0 12px; border: none; border-top: 1px solid #eee;" />

    <!-- elenco sedi -->
    <div id="sediList" class="sedi-list">
      <!-- riempito da JavaScript -->
    </div>
  </div>

  <script>
    const WEBAPP_URL =
      "https://script.google.com/macros/s/AKfycbxaiiuQovXIT44GjKBpPXMtMSDXAg51M1lCgi-fbFnGkBTqE5y4PnnaiBQC-HiYGpkC/exec";

    document.addEventListener("DOMContentLoaded", () => {
      const listEl = document.getElementById("sediList");

      function renderError(msg) {
        listEl.innerHTML = "<p>" + msg + "</p>";
      }

      fetch(WEBAPP_URL + "?action=listaSedi")
        .then((r) => r.json())
        .then((data) => {
          if (!data.ok || !Array.isArray(data.sedi)) {
            renderError("Errore nel caricamento delle sedi.");
            return;
          }

          listEl.innerHTML = "";

          data.sedi.forEach((sede) => {
            const card = document.createElement("div");
            card.className = "sede-card";

            const nome = sede.nomeSede || sede.locationId || "Sede";
            const indirizzo = sede.indirizzo || "";
            const locId = sede.locationId;

            card.innerHTML = `
              <div class="sede-card-title">${nome}</div>
              ${
                indirizzo
                  ? `<div class="sede-card-address">${indirizzo}</div>`
                  : ""
              }
              <button class="sede-card-btn" data-loc="${locId}">
                Apri timbro
              </button>
            `;

            listEl.appendChild(card);
          });

          listEl.addEventListener("click", (e) => {
            const btn = e.target.closest(".sede-card-btn");
            if (!btn) return;
            const loc = btn.getAttribute("data-loc");
            if (!loc) return;

            const url = "index.html?loc=" + encodeURIComponent(loc);
            window.location.href = url;
          });
        })
        .catch((err) => {
          console.error(err);
          renderError("Errore rete nel caricamento delle sedi: " + err.message);
        });
    });
  </script>
</body>
</html>
