<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Sedi – Timbro Facile</title>

  <!--  CSS  -->
  <link rel="stylesheet" href="css/base.css">
  <link rel="stylesheet" href="css/tema-cliente.css">
</head>
<body>
  <div class="app-shell">
    <div class="app-card app-card-wide">

      <!-- HEADER con logo + titolo -->
      <div class="app-header">
        <div class="logo-wrapper">
          <img src="img/logo.png" alt="Logo Aziendale" class="logo">
        </div>
        <div class="header-text">
          <div class="app-title">Seleziona la sede</div>
          <div class="app-subtitle">
            Scegli la sede o il cantiere in cui ti trovi per aprire la pagina di timbratura.
          </div>
        </div>
      </div>

      <div class="app-divider"></div>

      <div class="helper-text">
        Tocca la sede corretta per aprire la pagina di timbro. Puoi salvare la pagina tra i preferiti per usarla più velocemente.
      </div>

      <!-- QUI RENDERIZZIAMO I GRUPPI DI SEDI -->
      <div id="sediContainer" class="sedi-section">
        Caricamento sedi…
      </div>

    </div>
  </div>

<script>
// ===============================================
// CONFIGURAZIONE
// ===============================================

// Webhook Apps Script – endpoint "sedi"
const WEBHOOK_SEDI =
  "https://script.google.com/macros/s/AKfycbxaiiuQovXIT44GjKBpPXMtMSDXAg51M1lCgi-fbFnGkBTqE5y4PnnaiBQC-HiYGpkC/exec?action=sedi";

// Pagina di timbratura
const TIMBRO_PAGE = "index.html";


// ===============================================
// CARICAMENTO SEDI
// ===============================================
async function loadSedi() {
  const container = document.getElementById("sediContainer");
  try {
    const res = await fetch(WEBHOOK_SEDI);
    const data = await res.json();

    if (!data.ok) {
      container.textContent = "Errore nel caricare le sedi.";
      return;
    }

    renderGroupedSedi(data.sedi || []);

  } catch (err) {
    console.error(err);
    container.textContent = "Errore di connessione durante il caricamento delle sedi.";
  }
}


// ===============================================
// RAGGRUPPAMENTO SEDI (per comune / provincia)
// ===============================================
function getGroupLabel(sede) {
  const comune = (sede.comune || "").trim();
  const provincia = (sede.provincia || "").trim();

  if (comune && provincia) return `${comune} (${provincia})`;
  if (comune) return comune;
  if (provincia) return provincia;
  return "Altre sedi";
}


// ===============================================
// RENDERING GRUPPI + CARD SEDI
// ===============================================
function renderGroupedSedi(sedi) {
  const container = document.getElementById("sediContainer");
  container.innerHTML = "";

  if (!sedi.length) {
    container.textContent = "Nessuna sede configurata.";
    return;
  }

  // 1) Costruisco una mappa: gruppo -> array sedi
  const groups = {};
  sedi.forEach(s => {
    const g = getGroupLabel(s);
    if (!groups[g]) groups[g] = [];
    groups[g].push(s);
  });

  // 2) Ordino alfabeticamente i gruppi
  const groupNames = Object.keys(groups).sort((a, b) =>
    a.localeCompare(b, "it")
  );

  // 3) Per ogni gruppo, creo titolo + griglia card
  groupNames.forEach(groupName => {
    const sectionTitle = document.createElement("div");
    sectionTitle.className = "sedi-group-title";
    sectionTitle.textContent = groupName;
    container.appendChild(sectionTitle);

    const grid = document.createElement("div");
    grid.className = "sedi-grid";

    groups[groupName].forEach(s => {
      const card = document.createElement("div");
      card.className = "sede-card";

      const title = document.createElement("div");
      title.className = "sede-title";
      title.textContent = s.nomeSede || s.locationId;

      // Linea 2: indirizzo · città
      const line2 = document.createElement("div");
      line2.className = "sede-addr";
      const indirizzo = (s.indirizzo || "").trim();
      const citta = (s.citta || "").trim();
      const line2Parts = [];
      if (indirizzo) line2Parts.push(indirizzo);
      if (citta) line2Parts.push(citta);
      line2.textContent = line2Parts.join(" · ") || "Indirizzo non disponibile";

      // Linea 3: CAP + comune
      const line3 = document.createElement("div");
      line3.className = "sede-addr";
      const cap = (s.cap || "").trim();
      const comune = (s.comune || "").trim();
      const line3Parts = [];
      if (cap) line3Parts.push(cap);
      if (comune) line3Parts.push(comune);
      line3.textContent = line3Parts.join(" ");

      // Linea 4: provincia · regione
      const line4 = document.createElement("div");
      line4.className = "sede-addr";
      const provincia = (s.provincia || "").trim();
      const regione = (s.regione || "").trim();
      const line4Parts = [];
      if (provincia) line4Parts.push(provincia);
      if (regione) line4Parts.push(regione);
      line4.textContent = line4Parts.join(" · ");

      const actions = document.createElement("div");
      actions.className = "sede-actions";

      const btn = document.createElement("button");
      btn.className = "btn btn-primary";
      btn.textContent = "Apri timbro";
      btn.onclick = () => {
        const url = `${TIMBRO_PAGE}?loc=${encodeURIComponent(s.locationId)}`;
        window.location.href = url;
      };

      actions.appendChild(btn);

      card.appendChild(title);
      card.appendChild(line2);
      card.appendChild(line3);
      card.appendChild(line4);
      card.appendChild(actions);

      grid.appendChild(card);
    });

    container.appendChild(grid);
  });
}


// ===============================================
// AVVIO
// ===============================================
loadSedi();
</script>
</body>
</html>
