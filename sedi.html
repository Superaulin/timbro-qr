<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Sedi ‚Äì Timbro Facile</title>

  <!-- üé® CSS cliente -->
  <link rel="stylesheet" href="client.css">
</head>
<body>
  <div class="app-shell">
    <div class="app-card app-card-wide">

      <!-- HEADER con logo + titolo -->
      <div class="app-header">
        <div class="logo-wrapper">
          <!-- üëâ usa il logo gi√† presente nella cartella img -->
          <img src="img/logo.png" alt="Logo Aziendale" class="logo">
        </div>
        <div class="header-text">
          <div class="app-title">Seleziona la sede</div>
          <div class="app-subtitle">
            Scegli la sede o il cantiere in cui ti trovi per aprire la pagina di timbratura.
          </div>
        </div>
      </div>

      <div class="app-divider"></div>

      <div class="helper-text">
        Tocca la sede corretta per aprire la pagina di timbro. Puoi salvare la pagina tra i preferiti per usarla pi√π velocemente.
      </div>

      <!-- QUI RENDERIZZIAMO I GRUPPI DI SEDI -->
      <div id="sediContainer" class="sedi-section">
        Caricamento sedi‚Ä¶
      </div>

    </div>
  </div>

<script>
// ===============================================
// CONFIGURAZIONE
// ===============================================

// üî• Webhook Apps Script ‚Äì endpoint "sedi"
const WEBHOOK_SEDI = "https://script.google.com/macros/s/AKfycbw3UYl68d61ym-mPVrgh1QyphQaaWotOSgrczzNGRS3KD9euIpDg-nv60Ns06vRCfLx/exec?action=sedi";

// Pagina di timbratura (gi√† esistente)
const TIMBRO_PAGE = "index.html";


// ===============================================
// CARICAMENTO SEDI
// ===============================================
async function loadSedi() {
  const container = document.getElementById("sediContainer");
  try {
    const res = await fetch(WEBHOOK_SEDI);
    const data = await res.json();

    if (!data.ok) {
      container.textContent = "Errore nel caricare le sedi.";
      return;
    }

    renderGroupedSedi(data.sedi || []);

  } catch (err) {
    console.error(err);
    container.textContent = "Errore di connessione durante il caricamento delle sedi.";
  }
}


// ===============================================
// RAGGRUPPAMENTO SEDI (per citt√† / area)
// ===============================================
function getGroupLabel(sede) {
  const indirizzo = (sede.indirizzo || "").trim();

  if (!indirizzo) return "Altre sedi";

  // Proviamo pattern tipo: "Via ..., Citt√† - Provincia"
  // Esempio: "Via Francia 124, Guasticce - Livorno"
  let group = "";

  if (indirizzo.includes("-")) {
    // prendo la parte dopo il trattino
    const parts = indirizzo.split("-");
    group = parts[parts.length - 1].trim();
  } else if (indirizzo.includes(",")) {
    // prendo la parte dopo l'ultima virgola
    const parts = indirizzo.split(",");
    group = parts[parts.length - 1].trim();
  }

  if (!group) group = "Altre sedi";
  return group;
}


// ===============================================
// RENDERING GRUPPI + CARD SEDI
// ===============================================
function renderGroupedSedi(sedi) {
  const container = document.getElementById("sediContainer");
  container.innerHTML = "";

  if (!sedi.length) {
    container.textContent = "Nessuna sede configurata.";
    return;
  }

  // 1) Costruisco una mappa: gruppo -> array sedi
  const groups = {};
  sedi.forEach(s => {
    const g = getGroupLabel(s);
    if (!groups[g]) groups[g] = [];
    groups[g].push(s);
  });

  // 2) Ordino alfabeticamente i gruppi
  const groupNames = Object.keys(groups).sort((a, b) => a.localeCompare(b, "it"));

  // 3) Per ogni gruppo, creo titolo + griglia card
  groupNames.forEach(groupName => {
    const sectionTitle = document.createElement("div");
    sectionTitle.className = "sedi-group-title";
    sectionTitle.textContent = groupName;
    container.appendChild(sectionTitle);

    const grid = document.createElement("div");
    grid.className = "sedi-grid";

    groups[groupName].forEach(s => {
      const card = document.createElement("div");
      card.className = "sede-card";

      const title = document.createElement("div");
      title.className = "sede-title";
      title.textContent = s.nomeSede || s.locationId;

      const addr = document.createElement("div");
      addr.className = "sede-addr";
      addr.textContent = s.indirizzo || "Indirizzo non disponibile";

      const actions = document.createElement("div");
      actions.className = "sede-actions";

      const btn = document.createElement("button");
      btn.className = "btn btn-primary";
      btn.textContent = "Apri timbro";
      btn.onclick = () => {
        const url = `${TIMBRO_PAGE}?loc=${encodeURIComponent(s.locationId)}`;
        window.location.href = url;
      };

      actions.appendChild(btn);

      card.appendChild(title);
      card.appendChild(addr);
      card.appendChild(actions);

      grid.appendChild(card);
    });

    container.appendChild(grid);
  });
}


// ===============================================
// UTILITY
// ===============================================
// (Se ti serve escapeHtml puoi aggiungerlo, qui non √® strettamente necessario
//  perch√© i dati arrivano dal tuo foglio)


// ===============================================
// AVVIO
// ===============================================
loadSedi();
</script>
</body>
</html>
