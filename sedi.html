<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sedi – Timbro Presenze</title>

  <!-- CSS comuni -->
  <link rel="stylesheet" href="css/base.css">
  <link rel="stylesheet" href="css/tema-cliente.css">

  <!-- Stili specifici per la pagina sedi -->
  <style>
    .sedi-card {
      text-align: left;
    }

    .sedi-divider {
      margin: 12px 0;
      border: 0;
      border-top: 1px solid #eeeeee;
    }

    .sedi-section-title {
      font-size: 16px;
      margin: 8px 0 4px;
      color: var(--text-main);
      font-weight: 600;
    }

    .sedi-list {
      margin-top: 4px;
    }

    .sede-item {
      padding: 7px 0 10px;
      border-bottom: 1px solid #f0f0f0;
    }

    .sede-item:last-child {
      border-bottom: none;
    }

    .sede-nome {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-main);
    }

    .sede-address {
      font-size: 12px;
      color: var(--text-subtle);
    }

    .sede-distance {
      font-size: 11px;
      color: var(--text-subtle);
      margin-top: 2px;
    }

    .sede-actions {
      margin-top: 5px;
    }

    .sede-actions .login-button {
      font-size: 13px;
      padding: 6px 12px;
      flex: 0 0 auto;
    }

    .sedi-note {
      font-size: 11px;
      color: var(--text-subtle);
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div class="card sedi-card">
    <div class="sedi-header">
      <img src="img/logo.png" alt="Logo aziendale" class="logo-sedi">
      <div class="sedi-header-text">
        <h1>Seleziona la sede</h1>
        <p>
          Scegli la sede o il cantiere in cui ti trovi per aprire la pagina di timbratura.
          Puoi salvare la pagina tra i preferiti per usarla più velocemente.
        </p>
      </div>
    </div>

    <hr class="sedi-divider">

    <div id="sediContent">
      <p>Caricamento sedi in corso…</p>
    </div>

    <p class="sedi-note" id="sediNote"></p>
  </div>

  <script>
    // URL della WebApp – tienilo allineato con index.html
    const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbxaiiuQovXIT44GjKBpPXMtMSDXAg51M1lCgi-fbFnGkBTqE5y4PnnaiBQC-HiYGpkC/exec";

    // raggio in km per considerare una sede "vicina"
    const RAGGIO_KM = 20;

    const sediContentEl = document.getElementById("sediContent");
    const sediNoteEl = document.getElementById("sediNote");

    function setContent(html) {
      sediContentEl.innerHTML = html;
    }

    function setNote(msg) {
      sediNoteEl.textContent = msg || "";
    }

    function escapeHtml(str) {
      return String(str || "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;");
    }

    function distanceKm(lat1, lon1, lat2, lon2) {
      const R = 6371;
      const toRad = deg => deg * Math.PI / 180;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a =
        Math.sin(dLat / 2) ** 2 +
        Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
        Math.sin(dLon / 2) ** 2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    function renderSedi(vicine, altre, haGps) {
      let html = "";

      if (vicine.length > 0) {
        html += `<h2 class="sedi-section-title">Sedi vicino a te (entro ${RAGGIO_KM} km)</h2>`;
        html += `<div class="sedi-list">`;
        vicine.forEach(s => {
          html += renderSedeItem(s, true);
        });
        html += `</div>`;
      }

      const titleAltre = vicine.length > 0 ? "Altre sedi" : "Tutte le sedi";
      html += `<h2 class="sedi-section-title">${titleAltre}</h2>`;
      html += `<div class="sedi-list">`;
      altre.forEach(s => {
        html += renderSedeItem(s, false);
      });
      html += `</div>`;

      setContent(html);

      if (!haGps) {
        setNote("GPS non disponibile: viene mostrato l'elenco completo delle sedi.");
      } else if (vicine.length > 0) {
        setNote("Sono mostrate prima le sedi entro " + RAGGIO_KM + " km dalla tua posizione.");
      } else {
        setNote("Nessuna sede rilevata entro " + RAGGIO_KM + " km. Vengono mostrate tutte le sedi.");
      }
    }

    function renderSedeItem(sede, isVicino) {
      const nome = escapeHtml(sede.nomeSede || sede.locationId || "");
      const indirizzo = escapeHtml(sede.indirizzo || "");
      const distanza = typeof sede.distKm === "number"
        ? sede.distKm.toFixed(1).replace(".", ",") + " km"
        : null;

      return `
        <div class="sede-item">
          <div class="sede-nome">${nome}</div>
          ${indirizzo ? `<div class="sede-address">${indirizzo}</div>` : ""}
          ${distanza && isVicino ? `<div class="sede-distance">Distanza stimata: ${distanza}</div>` : ""}
          <div class="sede-actions">
            <button class="login-button btn-in"
                    onclick="openTimbro('${encodeURIComponent(sede.locationId)}')">
              Apri timbro
            </button>
          </div>
        </div>
      `;
    }

    // esposta in global per l'onclick
    function openTimbro(locEncoded) {
      window.location.href = "index.html?loc=" + locEncoded;
    }
    window.openTimbro = openTimbro;

    function getPosition() {
      if (!navigator.geolocation) {
        return Promise.resolve({ ok: false, reason: "NO_GPS" });
      }
      return new Promise(resolve => {
        navigator.geolocation.getCurrentPosition(
          pos => {
            resolve({
              ok: true,
              lat: pos.coords.latitude,
              lon: pos.coords.longitude,
              accuracy: pos.coords.accuracy
            });
          },
          () => {
            resolve({ ok: false, reason: "DENIED" });
          },
          {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 0
          }
        );
      });
    }

    function initSedi(allSedi) {
      // normalizza i numeri
      const sedi = (allSedi || []).map(s => ({
        ...s,
        lat: typeof s.lat === "number" ? s.lat : parseFloat(s.lat),
        lon: typeof s.lon === "number" ? s.lon : parseFloat(s.lon)
      }));

      setContent("<p>Rilevamento posizione in corso…</p>");

      getPosition().then(pos => {
        if (!pos.ok) {
          // niente GPS → elenco completo
          renderSedi([], sedi, false);
          return;
        }

        const vicine = [];
        const altre = [];

        sedi.forEach(s => {
          if (!isFinite(s.lat) || !isFinite(s.lon)) {
            altre.push(s);
            return;
          }
          const dist = distanceKm(pos.lat, pos.lon, s.lat, s.lon);
          if (dist <= RAGGIO_KM) {
            vicine.push({ ...s, distKm: dist });
          } else {
            altre.push(s);
          }
        });

        // ordina le vicine per distanza crescente
        vicine.sort((a, b) => a.distKm - b.distKm);

        renderSedi(vicine, altre, true);
      });
    }

    // Caricamento iniziale sedi dal backend
    (function loadSedi() {
      setContent("<p>Caricamento sedi in corso…</p>");
      setNote("");

      fetch(WEBAPP_URL + "?action=sedi")
        .then(r => r.json())
        .then(data => {
          if (!data || !data.ok) {
            setContent("<p>Errore nel caricamento delle sedi.</p>");
            setNote("Verifica la connessione o riprova più tardi.");
            return;
          }
          initSedi(data.sedi || []);
        })
        .catch(() => {
          setContent("<p>Errore di connessione durante il caricamento delle sedi.</p>");
          setNote("Controlla la connessione di rete e riprova.");
        });
    })();
  </script>
</body>
</html>
